<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OSRM Route Range Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .panel {
      position: absolute;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 1px 8px rgba(0, 0, 0, 0.16);
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.35;
    }
    #summary {
      top: 14px;
      left: 14px;
      min-width: 260px;
      max-width: 420px;
    }
    #legend {
      left: 14px;
      bottom: 14px;
      min-width: 320px;
      max-width: 560px;
      max-height: 44vh;
      overflow-y: auto;
    }
    #date-control {
      position: fixed;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      background: rgba(255, 255, 255, 0.96);
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 1px 8px rgba(0, 0, 0, 0.16);
      padding: 8px 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div id="date-control">
    <button id="play-toggle" style="padding:2px 8px;font-size:12px;">Play</button>
    <input id="date-slider" type="range" min="0" max="0" value="0" style="width:260px;" />
    <div id="date-label" style="font-weight:600;min-width:90px;text-align:center;"></div>
    <label for="speed-select">Delay</label>
    <select id="speed-select" style="padding:2px 4px;font-size:12px;">
      <option value="1" selected>1s</option>
      <option value="3">3s</option>
      <option value="5">5s</option>
      <option value="10">10s</option>
    </select>
    <div style="margin-left:6px;font-size:11px;color:#555;">
      Range: 2021-01-01 to 2021-01-31
    </div>
  </div>

  <div id="summary" class="panel">
    <div><strong>Date:</strong> <span id="summary-date">-</span></div>
    <div><strong>Total Distance:</strong> <span id="summary-distance">-</span></div>
    <div><strong>Total Duration:</strong> <span id="summary-duration">-</span></div>
    <div><strong>Routes:</strong> <span id="summary-routes">-</span></div>
    <div><strong>Missing Coords:</strong> <span id="summary-missing">-</span></div>
    <div><strong>Savers Locations:</strong> 7</div>
  </div>

  <div id="legend" class="panel">
    <div style="margin-bottom:8px;"><strong>Route Legend (Driver)</strong></div>
    <div id="legend-content"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const center = [41.73119199560214, -71.44721814212213];
    const dayData = [];
    const saversPoints = [{"lat": 41.70142361406466, "lon": -71.49622935849673, "address": "24 Universal Blvd, Warwick, RI 02886"}, {"lat": 41.847375324977705, "lon": -71.41240583119033, "address": "201 Branch Ave, Providence, RI 02904"}, {"lat": 41.676587611969445, "lon": -71.16447284264083, "address": "109 Mariano Bishop Blvd, Fall River, MA 02721"}, {"lat": 41.823419466068685, "lon": -71.3578806685053, "address": "1925 Pawtucket Ave, East Providence, RI 02914"}, {"lat": 41.93717861460553, "lon": -71.35158547209568, "address": "1385 S Washington St, North Attleborough, MA 02760"}, {"lat": 41.67611733360954, "lon": -70.94111882728663, "address": "1014 Kings Hwy, New Bedford, MA 02745"}, {"lat": 42.01669053076259, "lon": -71.4775488238762, "address": "1500 Diamond Hill Rd, Woonsocket, RI 02895"}];
    const map = L.map('map').setView(center, 10);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    function escapeHtml(text) {
      return String(text)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function firstStopIcon(color) {
      return L.divIcon({
        className: '',
        iconSize: [22, 22],
        iconAnchor: [11, 11],
        html: '<div style="width:22px;height:22px;border-radius:50%;background:' + color + ';color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center;border:2px solid #fff;box-shadow:0 0 0 1px ' + color + ';font-size:12px;">1</div>'
      });
    }

    function lastStopIcon(color) {
      return L.divIcon({
        className: '',
        iconSize: [22, 22],
        iconAnchor: [11, 11],
        html: '<div style="width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid ' + color + ';display:flex;align-items:center;justify-content:center;box-shadow:0 0 0 1px ' + color + ';"><div style="width:10px;height:10px;background:' + color + ';"></div></div>'
      });
    }

    function saversIcon() {
      return L.divIcon({
        className: '',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        html: '<div style="width:24px;height:24px;border-radius:50%;background:#d62728;color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center;border:2px solid #fff;box-shadow:0 0 0 1px #b51f1f;font-size:13px;">S</div>'
      });
    }

    function stopDotIcon(color) {
      return L.divIcon({
        className: '',
        iconSize: [10, 10],
        iconAnchor: [5, 5],
        html: '<div style="width:10px;height:10px;border-radius:50%;background:' + color + ';display:flex;align-items:center;justify-content:center;"><div style="width:5.6px;height:5.6px;border-radius:50%;background:#000;"></div></div>'
      });
    }

    const bounds = [];

    for (const s of saversPoints) {
      L.marker([s.lat, s.lon], { icon: saversIcon() }).addTo(map).bindPopup(
        'Savers Drop-off<br>' + s.address
      );
      bounds.push([s.lat, s.lon]);
    }

    const dateLayers = {};
    for (const day of dayData) {
      const layer = L.layerGroup();
      for (const route of day.routes) {
        if (route.route_points.length > 0) {
          for (const p of route.route_points) bounds.push(p);
        }

        if (route.route_points.length >= 2) {
          const baseLineStyle = {
            color: route.color,
            weight: 4,
            opacity: 0.9
          };
          const focusLineStyle = {
            color: route.color,
            weight: 7,
            opacity: 1.0
          };
          const line = L.polyline(route.route_points, baseLineStyle).addTo(layer);
          line.on('mouseover', function() {
            this.setStyle(focusLineStyle);
            this.bringToFront();
          });
          line.on('mouseout', function() {
            this.setStyle(baseLineStyle);
          });
        }

        for (const stop of route.stops) {
          L.marker([stop.lat, stop.lon], {
            icon: stopDotIcon(route.color)
          }).addTo(layer).bindPopup(
            route.driver + ' | Stop ' + stop.stop +
            '<br>Raw Address: ' + stop.raw_address +
            '<br>OSM Display Name: ' + stop.osm_display_name
          );
        }

        if (route.first_stop) {
          L.marker(route.first_stop, {
            icon: firstStopIcon(route.color)
          }).addTo(layer).bindPopup(route.driver + ' | First stop');
          bounds.push(route.first_stop);
        }

        if (route.last_stop) {
          L.marker(route.last_stop, {
            icon: lastStopIcon(route.color)
          }).addTo(layer).bindPopup(route.driver + ' | Last stop');
          bounds.push(route.last_stop);
        }
      }
      dateLayers[day.date] = layer;
    }

    const slider = document.getElementById('date-slider');
    const label = document.getElementById('date-label');
    const playBtn = document.getElementById('play-toggle');
    const speedSelect = document.getElementById('speed-select');
    const legendContent = document.getElementById('legend-content');
    const summaryDate = document.getElementById('summary-date');
    const summaryDistance = document.getElementById('summary-distance');
    const summaryDuration = document.getElementById('summary-duration');
    const summaryRoutes = document.getElementById('summary-routes');
    const summaryMissing = document.getElementById('summary-missing');

    let timer = null;
    let playing = false;

    function renderLegend(day) {
      if (!day || !day.routes || day.routes.length === 0) {
        legendContent.innerHTML = '<div>No routes for this date.</div>';
        return;
      }

      const rows = day.routes.map((route) => {
        const osrmTag = route.osrm_error
          ? (route.straight_fallback_used ? ' (Straight-line fallback)' : ' (OSRM route unavailable)')
          : '';
        return (
          "<div style='margin-bottom:6px;'>" +
          "<span style='display:inline-block;width:12px;height:12px;background:" + route.color + ";margin-right:6px;vertical-align:middle;'></span>" +
          "<strong>" + escapeHtml(route.driver) + "</strong> " +
          "(stops " + route.stops_total + ", missing " + route.missing_stops + "): " +
          escapeHtml(route.distance_text) + ", " + escapeHtml(route.duration_text) +
          osrmTag +
          "</div>"
        );
      });
      rows.push(
        "<div style='margin-top:8px;font-size:11px;color:#555;'>Missing coord rows (total): " +
        day.missing_total +
        "</div>"
      );
      legendContent.innerHTML = rows.join('');
    }

    function renderSummary(day) {
      summaryDate.textContent = day.date;
      summaryDistance.textContent = day.total_distance_text;
      summaryDuration.textContent = day.total_duration_text;
      summaryRoutes.textContent = String(day.routes_count);
      summaryMissing.textContent = String(day.missing_total);
    }

    function showDateByIndex(idx) {
      if (dayData.length === 0) {
        return;
      }
      const clamped = Math.max(0, Math.min(dayData.length - 1, idx));
      const selected = dayData[clamped];

      for (const day of dayData) {
        const layer = dateLayers[day.date];
        if (layer && map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      }

      const selectedLayer = dateLayers[selected.date];
      if (selectedLayer) {
        selectedLayer.addTo(map);
      }

      slider.value = String(clamped);
      label.textContent = selected.date;
      renderLegend(selected);
      renderSummary(selected);
    }

    function stopPlayback() {
      playing = false;
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      playBtn.textContent = 'Play';
    }

    function startPlayback() {
      if (dayData.length === 0) return;
      playing = true;
      playBtn.textContent = 'Pause';
      const delaySec = parseInt(speedSelect.value || '1', 10) || 1;
      timer = setInterval(() => {
        const current = parseInt(slider.value || '0', 10);
        const next = (current + 1) % dayData.length;
        showDateByIndex(next);
      }, delaySec * 1000);
    }

    slider.addEventListener('input', (e) => {
      stopPlayback();
      showDateByIndex(parseInt(e.target.value, 10));
    });

    speedSelect.addEventListener('change', () => {
      if (playing) {
        stopPlayback();
        startPlayback();
      }
    });

    playBtn.addEventListener('click', () => {
      if (playing) stopPlayback();
      else startPlayback();
    });

    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [24, 24] });
    }
    showDateByIndex(0);
  </script>
</body>
</html>
